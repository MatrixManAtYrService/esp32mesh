<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 Web Flasher (Local Bundle + Verbose)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #222;
      color: #eee;
      padding: 30px;
      text-align: center;
    }
    button {
      font-size: 16px;
      margin: 10px;
      padding: 10px 20px;
      cursor: pointer;
    }
    #log {
      background: #000;
      color: #0f0;
      font-family: monospace;
      text-align: left;
      white-space: pre-wrap;
      border-radius: 5px;
      border: 1px solid #444;
      padding: 10px;
      width: 90%;
      height: 300px;
      margin: 20px auto;
      overflow-y: scroll;
    }
  </style>
</head>
<body>
  <h1>ESP32 Web Flasher (Local Bundle + Verbose)</h1>
  <p><strong>Firmware:</strong> <code>firmware.bin</code></p>
  <button id="connectBtn">üîå Connect</button>
  <button id="flashBtn" disabled>‚ö° Flash</button>
  <div id="log">Console output...</div>

  <!-- Load your local bundle.js here -->
  <script src="bundle.js"></script>

  <script>
    const logEl = document.getElementById('log');
    const connectBtn = document.getElementById('connectBtn');
    const flashBtn = document.getElementById('flashBtn');

    let port = null;
    let chip = null;
    let firmware = null;

    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logEl.textContent += `\n[${t}] ${msg}`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    log("üì¶ Page loaded");

    if (!('serial' in navigator)) {
      log("‚ùå Web Serial API not supported.");
      connectBtn.disabled = true;
    }

    // Load firmware locally from same folder
    fetch("firmware.bin")
      .then(res => {
        log("üì° Fetching firmware.bin...");
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.arrayBuffer();
      })
      .then(buf => {
        firmware = new Uint8Array(buf);
        log(`‚úÖ firmware.bin loaded (${firmware.length} bytes)`);
      })
      .catch(err => log("‚ùå Firmware load failed: " + err.message));

    connectBtn.addEventListener("click", async () => {
      try {
        log("üîç Requesting serial port...");
        port = await navigator.serial.requestPort();
        log("üñß Port selected.");

        log("üîë Opening port...");
        await port.open({ baudRate: 115200 });
        log("‚úÖ Port opened.");

        if (!window.ESPWebTools || !window.ESPWebTools.ESPLoader) {
          log("‚ùå ESPWebTools or ESPLoader not found on window object.");
          return;
        }

        log("‚öôÔ∏è Creating ESPLoader instance...");
        chip = new window.ESPWebTools.ESPLoader(port, false, log);

        log("üîÑ Initializing chip...");
        await chip.initialize();
        log("‚úÖ Chip initialized.");

        flashBtn.disabled = false;
        log("üöÄ Ready to flash!");
      } catch (e) {
        log("‚ùå Connect error: " + e.message);
      }
    });

    flashBtn.addEventListener("click", async () => {
      if (!firmware) {
        log("‚ö†Ô∏è Firmware missing");
        return;
      }
      if (!chip) {
        log("‚ö†Ô∏è Chip not connected");
        return;
      }
      try {
        log("‚ö° Flashing firmware...");
        await chip.flashData([{ data: firmware, address: 0x1000 }], true);
        log("‚úÖ Flash complete.");

        log("üîå Disconnecting...");
        await chip.transport.disconnect();
        log("üîå Port disconnected.");

        flashBtn.disabled = true;
      } catch (e) {
        log("‚ùå Flash error: " + e.message);
      }
    });
  </script>
</body>
</html>
